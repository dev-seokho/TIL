# Mutex, Semaphore, Spinlock, Monitor

### ✅ 교착 상태 (Deadlock)

교착상태는 상호 배제에 의해 나타나는 문제점입니다.  
서로 다른 둘 이상의 프로세스/스레드가 자원을 놓아줄 생각을 하지 않고 다른 프로세스/스레드가 점유하고 있는 자원을 무한정 기다리고 있는 상태를 교착상태라고 합니다. 

### ✅ 임계 영역 (Critical section)

교착상태를 일으킬 수 있는 영역을 임계영역이라고 합니다.  
공유 데이터의 일관성을 보장하기 위해서 하나의 프로세스/스레드만 진입해서 실행 가능한 영역입니다.  
멀티 프로그래밍 환경에서 동기화 기법은 Mutex, Semaphore, Monitor가 있습니다.  

### ✅ Mutex (뮤텍스)

여러 스레드를 실행하는 환경에서 자원에 대한 접근에 제한을 강제하기 위한 상호 배제 방식의 동기화 기법입니다.

- Boolean 타입의 Lock 변수를 사용합니다. 따라서 1개의 공유 자원에 대한 접근을 제한합니다.
- 임계 영역에서 공유 자원을 사용 중인 스레드가 있을 때, 다른 스레드가 공유 자원에 접근한다면 블로킹 후 대기 큐로 보내서 슬립시키는 방식을 사용합니다.
- Lock을 건 스레드만 Lock을 해제할 수 있습니다.
- Java에는 뮤텍스 라이브러리가 없으므로 비슷하게 구현하기 위해서는 이진 세마포어를 사용해야 합니다.

### ✅ Spinlock (스핀락)

기본적으로 뮤텍스와 유사하지만 다른 스레드가 공유 자원에 접근하면 블로킹 후 대기 큐로 보내는 것과 다르게 **Busy-waiting 방식으로 대기 큐**를 가지지 않습니다.  
계속해서 Lock을 가지기 위해서 기다리며, Mutex-nonblocking 방식으로 볼 수 있습니다.

단점은 Lock을 가질 수 있을 때 까지 반복적인 시도를 하기 때문에 기다리는 동안 CPU를 계속해서 낭비하는 단점이 있습니다.  
만약 컨텍스트 스위칭 시간이 더 짧거나, 멀티 코어 프로세스일 때 스핀락이 뮤텍스보다 이점이 있다고 볼 수 있습니다.

### ✅ Semaphore (세마포어)

뮤택스와 다르게 여러 스레드가 함께 공유자원에 접근할 수 있습니다.  
멀티 프로그래밍 환경에서 다수의 프로세스나 스레드가 n개의 공유 자원에 대한 접근을 제한하는 방법으로 사용되는 동기화 기법입니다. Java 에서도 세마포어 Class가 존재하지만, 모니터 방식의 상호배제를 채택하여 사용합니다.

- 세마포어 변수를 통해서 Wait(임계 영역에 진입), Signal(임계 영역에서 퇴장)을 관리합니다. 세마포어 변수는 0 이상의 정수형 변수를 가집니다.
- 접근 가능한 **공유 자원의 수가 2개 이상일 때는 계수 세마포어(Couting Semaphore)**라고 합니다.
- 접근 가능한 **공유 자원의 수가 1개일 때는 이진 세마포어(Binary Semaphore)**로 뮤텍스와 유사하게 사용할 수 있습니다. (하지만 둘이 같은 것은 아닙니다.)
- 큐에 연결된 스레드를 깨우는 방식에 따라서 강성 세마포어(큐에 연결된 스레드를 깨울 때 FIFO) 약성 세마포어(큐에 연결된 스레드를 깨울 때 순서를 특별히 명시하지 않음) 으로 구분됩니다.
- 세마포어는 Signaling 메커니즘으로 Lock을 걸지 않은 스레드도 Signal을 보내 Lock을 해제할 수 있습니다.

#### 세마포어의 단점

세마포어는 wait & signal 연산 순서를 바꿔서 실행하거나 둘 중 하나라도 생략하면 고착 상태가 발생하고 wait & signal 연산이 프로그램 전체에 구성되어 있으며 세마포어의 영향이 미치는 곳이 어딘지 파악하기 어렵기 때문에 세마포어를 사용해 프로그램을 구현하는 것은 매우 어렵습니다.  
이를 극복하기 위해 모니터가 등장했습니다.

### ✅ Monitor (모니터)

모니터는 임계구역을 지켜내기 위한 방법인 상호 배제를 프로그램으로 구현한 것이며, 공유 자원, 공유 자원 접근함수와 두 개의 큐로 구성 돼 있습니다.   공유 자원을 점유 중인 프로세스(스레드)는 Lock을 가지고 상호베타 큐(Mutual Exclusion Queue) 에 대기하며, 공유 자원의 Lock이 해제되기를 기다리는 프로세스(스레드)는 조건동기 큐(Conditional Synchronization Queue)에서 대기합니다.

자바에서 동기화를 위해 모니터 방식을 채택하고 있으며 `synchronized`를 임계 영역을 정해 공유 자원의 스레드 간의 동기화를 할 수 있고, 모니터의 공유 자원 접근 함수(wait(), notify(), notifyAll())을 통해서 Lock을 관리할 수 있습니다. 참고로 이러한 모니터의 공유 자원 접근 함수는 `synchronized` 블록에서만 유의미 합니다.

**wait()**

Lock을 가진 스레드가 다른 스레드에 Lock을 넘겨준 다음 대기해야 할 때 사용합니다.  

**notify()**

대기하고 있는 스레드 중 하나를 깨웁니다.  

**notifyAll()**

대기하고 있는 스레드 모두를 깨웁니다.  