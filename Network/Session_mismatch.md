# 세션 불일치 현상이 발생하는 이유와, 이를 해결하기 위한 방법

## 세션 불일치 현상이 발생하는 이유

**Scale out은 여러대의 서버를 함께 사용하기 때문에 서버가 각각 세션 저장소를 독립적으로 갖게 되며, 이는 곧 세션의 불일치 현상(정합성이 유지되지 않는 이슈)이 발생하게 되는 원인**이 됩니다. 이 문제를 해결하기 위한 방법은 크게 다음과 같이 나눌 수 있습니다.  
또한 이 문제를 해결할때에도 Scale out과 Scale up을 선택할 때 처럼 정확한 정답이 있는 것은 아니며, 상황에 맞게 사용해야 합니다.  

1. **Sticky Session** : 클라이언트 요청을 세션 정보를 가지고 있는 서버에만 보내는 방법.
2. ****Session Clustering**** : 세션 정보를 모든 서버에 공유하는 방법.
3. **Session Stroage 분리** : 서버가 세션 상태(데이터)를 가지지 않도록 Stateless 서버를 구현하고 Session Storage를 분리하는 방법.

하나씩 방법을 살펴보겠습니다.

## Sticky Session

**Sticky Session이란 고정된 세션을 의미하며, 클라이언트 요청을 세션 정보를 가지고 있는 서버에만 보내는 방법**입니다. 이 행동은 로드 밸런서가 도와줍니다.  
로드밸런서가 동일한 클라이언트의 요청을 세션이 생성된 서버로만 보내도록하며, 쿠키 값이나 IP 세부 정보를 통해서 동일한 클라이언트인지 판별합니다. 이러한 과정을 통해서 세션이 유지되는 동안 동일한 서버만을 사용할 수 있고, 세션 불일치 문제를 해결할 수 있습니다.  

하지만 **특정 조건으로 인해 한개의 서버로 많은 트래픽이 몰릴 우려가 있고, 이는 결국 Scale out의 장점인 다수의 서버 운용의 이점을 최대로 활용할 수 없는 문제가 발생**하며, 한개의 서버에서 장애가 생긴다면 해당 서버에 국한된 세션 정보가 사라지기 때문에 다른 서버에서 세션 인증을 다시해야만 하는 문제가 발생합니다.

## Session Clustering

**세션 정보를 모든 서버에 공유하는 방법**입니다. 대표적인 WAS인 톰캣을 활용해서 Session Clustering을 구현해볼 수 있습니다. 톰캣의 DeltaManager가 **생성된 세션을 모든 서버에 복제를 해주는 방법**이며, 이를 통해서 다른 서버가 같은 세션을 유지하기 때문에 동일한 서비스 환경을 가질 수 있습니다.

하지만 세션을 모든 서버에 복제하는 것에 대한 트래픽이 발생하고, Scale out의 확장으로 인해 서버의 수가 늘어난다면 서버가 감당해야할 세션과 트래픽이 매우 증가하기 때문에, **Tomcat에서도 소규모 환경에서(노드 4개 이하) 권장**합니다.

이를 해결하기 위해서 Tomcat에서는 **BackupManger를 이용한 방법 또한 제공**하는데, 이 방법은 세션을 모든 서버에 복제하지 않고, 백업(Secondary) 서버에만 복제한뒤, 나머지 서버에는 Session ID와 메인(Primary)서버, 백업(Secondary)서버의 주소만 가지고 있도록 합니다. 만약 요청이 Primary서버나 Secondary 서버가 아닌 다른 서버로 요청된다면 Primary서버로 요청을 보내서 세션 데이터를 복제합니다.

하지만 이 또한 여전히 `만약 요청이 Primary서버나 Secondary 서버가 아닌 다른 서버로 요청된다면 Primary서버로 요청을 보내서 세션 데이터를 복제합니다.` 부분에서 알 수 있듯, 세션 복제를 위한 과정이 수행되기 때문에 완벽한 대안책이 되지는 못합니다. 또한 Session Clustering 방식은 결국 모든 서버가 세션 객체를 가져야하는 것과 마찬가지기 때문에 많은 메모리가 필요합니다.

## Session Storage 분리

**Session 저장소를 분리하여 세션을 저장하지 않고 필요시 조회하도록 만드는 방법**입니다.  
이는 Sticky Session과 Session Clustering의 단점을 보완해 줄 수 있는데, 한 서버에 트래픽이 비정상적으로 몰리는 현상을 해결할 수 있으며, 서버 하나에 장애가 발생하더라도 세션 저장소가 분리되어 있기 때문에 서비스에 문제가 생기지 않습니다. 또한 Session Clustering 방식은 각각의 서버가 동일한 Session 객체를 가지고 있기 때문에 메모리가 많이 필요한 반면에, Session Storage 분리 방식은 메모리가 많이 필요하지 않습니다.

하지만 세션 저장소를 따로 분리하기 때문에 서버의 관리 포인트가 증가하며, **분리된 세션 저장소에서 장애가 발생한다면 세션을 사용하는 모든 서버에 영향이 생길 수 있습니다.** 이를 해결하기 위해 동일한 세션 저장소를 하나 더 구성하는 방법을 사용할 수도 있습니다. (마스터-슬레이브 복제)

또한 결국 세션을 외부에서 가져오는 작업을 거쳐야하기 때문에, 로컬 메모리에서 세션을 가지고 있는 것보다 성능적인 면에서 단점을 가질 수 있습니다.